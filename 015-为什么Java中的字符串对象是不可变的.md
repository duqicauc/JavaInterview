> 本文首发于公众号：javaadu

所谓**不可变对象**，是指一个对象在创建后，它的内部状态不会被改变的对象。这意味着当我们将一个不可变对象的引用赋值给某个变量后，我们就不能改变该对象的内部状态。 James Gosling也说过——Java开发者应该尽量使用不可变对象。

在Java中将String对象设置为不可变对象的好处很多，例如：缓存、安全、同步、性能等方面。

## 字符串对象不可变的好处

### 字符串共享
**字符串常量池**：字符串常量池是JVM中的一块特殊区域（1.7之前存放在perm区，1.8之后存放在堆上），用来存放字符串对象的值。在JVM中字符串是不可变的，因此JVM对于相同的字符序列，可以只保存一份，这个特性称之为“interning”。由于字符串是JVM中最常见的对象，因此实现字符串共享可以节省很多堆内存。
![Why_String_Is_Immutable_In_Java.jpg](https://upload-images.jianshu.io/upload_images/44770-57609796e67713cd.jpg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)


有两种方式定义的字符串，可以存放在常量池中：
 - 使用常量字符串初始化字符串变量
 ```java
 String s1 = "Hello World";
 String s2 = "Hello World";
 
 System.out.printlin(s1 == s2); //结果为true
 ```
 - 调用String对象的intern方法，需要注意的是：直接通过String的构造方法初始化的字符串对象，它的值并没有存放在字符串常量池，需要对该对象调用intern方法之后，才会将它的值放入字符串常量池。
 ```java
 String s1 = "Hello World";
 String s2 = new String("Hello World");
 System.out.println(s1 == s2); //结果为false
 
 s2 = s2.intern();
 System.out.println(s1 == s2); //结果为true
 ```

### 安全性
Java应用中使用字符串对象存放一些敏感信息：用户名、密码、连接地址、IP地址等等。Java中类加载器加载类的时候，也是根据类的名字去文件系统中的对应路径去查找的，类的名称、对应的路径，都是使用字符串对象存储的。

将字符串对象设计为不可变的，就意味着这个敏感信息一经生成就不会被改变（有点现在流行的区块链的思路）。

常见的安全检查流程有两个步骤：（1）校验安全信息；（2）进行敏感操作。如果字符串对象是可变的，则在做完第（1）步安全校验后这个字符串对象依然可能被改变。例如，我们现在在维护一个用户服务，提供了更改用户昵称的服务，业务逻辑是先检查用户昵称的合法性，然后再进行数据库的操作，**如果字符串对象是可变的，那么第一步的合法性检查就没有意义了**。

### 并发同步
不可变对象天然具备线程安全性，因为不用担心两个线程同时修改该对象时候产生的争用问题。假设字符串变量`str = "hello"`被多个线程同时使用，如果在某个线程中对str赋了新的字符串值，那么就会在字符串常量池中生成一份新的字符串，不会有并发争用。

### Hashcode缓存
在Java集合框架的很多数据结构中都用到了字符串对象，例如*HashMap*、*HashTable*、*HashSet*等等，在这些数据结构的实现过程中，都使用*hashcode()*方法来进行hash操作。

由于字符串对象的不变性，JDK将它的hashcode()做了缓存，这样对于同一个字符串对象，只会在第一次调用它的hashcode()方法的时候进行计算，后面的调用直接使用缓存中的值，这缓存也提升了集合数据结构的性能。

## 结论
这个问题考察得比较细致，需要用对应的案例进行理解，不可变的字符串对象对于Java应用来说不可或缺，下图是写这篇文章时候用到的思维导图：
![字符串对象的不可变 (1).png](https://upload-images.jianshu.io/upload_images/44770-76d267143b824ca1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240)
